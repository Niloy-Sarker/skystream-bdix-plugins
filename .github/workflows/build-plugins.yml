name: Build and Release Plugins

on:
  push:
    branches:
      - main
    paths:
      - 'plugins/*.js'
      - 'plugins/plugins.json'
      - 'bdix_repo.json'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Build .sky files
        run: |
          mkdir -p build/plugins
          
          # Process each .js file in plugins directory (excluding plugins.json)
          for jsfile in plugins/*.js; do
            if [ -f "$jsfile" ]; then
              # Get the base name without extension
              basename=$(basename "$jsfile" .js)
              
              echo "Building $basename.sky..."
              
              # Create temp directory
              temp_dir=$(mktemp -d)
              
              # Copy and rename to plugin.js
              cp "$jsfile" "$temp_dir/plugin.js"
              
              # Create .sky file (zip with plugin.js at root)
              cd "$temp_dir"
              zip -q "../$basename.sky" plugin.js
              cd -
              
              # Move to build directory
              mv "$temp_dir/../$basename.sky" "build/plugins/$basename.sky"
              
              # Cleanup
              rm -rf "$temp_dir"
              
              echo "âœ“ Created $basename.sky"
            fi
          done
          
          # Copy metadata files
          cp plugins/plugins.json build/plugins/
          cp bdix_repo.json build/
          
          echo "Build complete!"
          ls -lh build/plugins/
      
      - name: Update plugins.json URLs
        run: |
          cd build/plugins
          
          # Update URLs in plugins.json to point to .sky files in release branch
          node -e "
          const fs = require('fs');
          const plugins = JSON.parse(fs.readFileSync('plugins.json', 'utf8'));
          
          plugins.forEach(plugin => {
            const internalName = plugin.internalName;
            plugin.url = \`https://raw.githubusercontent.com/niloy-sarker/skystream-bdix-plugins/refs/heads/release/plugins/\${internalName}.sky\`;
          });
          
          fs.writeFileSync('plugins.json', JSON.stringify(plugins, null, 2));
          console.log('Updated plugins.json URLs to point to .sky files in release branch');
          "
          
          cat plugins.json
      
      - name: Checkout release branch
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # Fetch release branch
          git fetch origin release:release 2>/dev/null || true
          
          # Checkout release branch, create if doesn't exist
          git checkout release 2>/dev/null || git checkout --orphan release
      
      - name: Deploy to release branch
        run: |
          # Clear existing content (for orphan branch scenario)
          git rm -rf . 2>/dev/null || true
          
          # Create plugins directory
          mkdir -p plugins
          
          # Copy built files
          cp build/plugins/*.sky plugins/ 2>/dev/null || true
          cp build/plugins/plugins.json plugins/
          cp build/bdix_repo.json .
          
          # Add and commit
          git add -A
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸš€ Auto-build: Update .sky files and metadata [skip ci]"
            git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git release --force
            echo "âœ“ Pushed to release branch"
          fi
      
      - name: Summary
        run: |
          echo "### Build Summary ðŸ“¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Built the following plugins:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          for skyfile in build/plugins/*.sky; do
            if [ -f "$skyfile" ]; then
              basename=$(basename "$skyfile")
              size=$(du -h "$skyfile" | cut -f1)
              echo "- âœ… \`$basename\` ($size)" >> $GITHUB_STEP_SUMMARY
            fi
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository URL:** \`https://raw.githubusercontent.com/niloy-sarker/skystream-bdix-plugins/refs/heads/release/bdix_repo.json\`" >> $GITHUB_STEP_SUMMARY
