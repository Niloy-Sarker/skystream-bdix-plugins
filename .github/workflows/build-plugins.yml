name: Build and Release Plugins

on:
  push:
    branches:
      - main
    paths:
      - 'plugins/*.js'
      - 'plugins/plugins.json'
      - 'bdix_repo.json'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build .sky files and prepare release
        run: |
          mkdir -p release/plugins
          
          # Build .sky files from each .js plugin
          for jsfile in plugins/*.js; do
            if [ -f "$jsfile" ]; then
              name=$(basename "$jsfile" .js)
              echo "Building $name.sky..."
              
              temp_dir=$(mktemp -d)
              cp "$jsfile" "$temp_dir/plugin.js"
              (cd "$temp_dir" && zip -q "$name.sky" plugin.js)
              mv "$temp_dir/$name.sky" "release/plugins/"
              rm -rf "$temp_dir"
              
              echo "âœ“ Created $name.sky"
            fi
          done
          
          # Copy metadata files as-is
          cp plugins/plugins.json release/plugins/
          cp plugins/repo.json release/plugins/
          cp bdix_repo.json release/
          
          echo "=== Build Complete ==="
          ls -lh release/plugins/
      
      - name: Deploy to release branch
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # Save release files
          cp -r release /tmp/release_files
          
          # Switch to release branch
          git fetch origin release:release 2>/dev/null || true
          git checkout release 2>/dev/null || git checkout --orphan release
          
          # Clean and copy release files
          git rm -rf . 2>/dev/null || true
          rm -rf ./* 2>/dev/null || true
          
          mkdir -p plugins
          cp /tmp/release_files/plugins/*.sky plugins/
          cp /tmp/release_files/plugins/plugins.json plugins/
          cp /tmp/release_files/plugins/repo.json plugins/
          cp /tmp/release_files/bdix_repo.json .
          
          # Commit and push
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸš€ Auto-build: Update plugins [skip ci]"
            git push origin release --force
            echo "âœ“ Pushed to release branch"
          fi
      
      - name: Summary
        run: |
          echo "### Build Summary ðŸ“¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release branch structure:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "â”œâ”€â”€ bdix_repo.json" >> $GITHUB_STEP_SUMMARY
          echo "â””â”€â”€ plugins/" >> $GITHUB_STEP_SUMMARY
          echo "    â”œâ”€â”€ *.sky (plugin files)" >> $GITHUB_STEP_SUMMARY
          echo "    â”œâ”€â”€ plugins.json" >> $GITHUB_STEP_SUMMARY
          echo "    â””â”€â”€ repo.json" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository URL:** \`https://raw.githubusercontent.com/${{ github.repository }}/refs/heads/release/bdix_repo.json\`" >> $GITHUB_STEP_SUMMARY
